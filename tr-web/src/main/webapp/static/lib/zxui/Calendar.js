define("zxui/Calendar",["require","./lib","./Control","./Popup"],function(require){function e(e){return(e>9?"":"0")+e}var t=require("./lib"),i=require("./Control"),n=require("./Popup"),r="yyyy-MM-dd",o={},a=i.extend({type:"Calendar",options:{disabled:!1,main:"",prefix:"ecl-ui-cal",target:"",triggers:"",dateFormat:"",range:null,value:"",process:null,monthes:2,first:0,lang:{week:"周",days:"日,一,二,三,四,五,六",title:"{year}年{month}日"}},binds:"onClick,onBeforeShow,onHide",init:function(e){this.disabled=e.disabled,this.dateFormat=e.dateFormat||a.DATE_FORMAT||r,this.days=e.lang.days.split(","),this.value=this.format(this.from(e.value));var t=this.cacheKey=e.first+"-"+e.lang.title;o[t]=o[t]||{},this.setRange(e.range||a.RANGE)},from:function(e,i){if(i=i||this.dateFormat,t.isString(e)){if(!e)return new Date;i=i.split(/[^yMdW]+/i),e=e.split(/\D+/);for(var n={},r=0,o=i.length;o>r;r++)if(i[r]&&e[r]&&(i[r].length>1&&e[r].length===i[r].length||1===i[r].length))n[i[r].toLowerCase()]=e[r];var a=n.yyyy||n.y||(n.yy<50?"20":"19")+n.yy,s=0|(n.m||n.mm),l=0|(n.d||n.dd);return new Date(0|a,s-1,l)}return e},format:function(i,n){if(n=(n||this.dateFormat).toLowerCase(),t.isString(i))i=this.from(i);var r=this.options,o=r.first,a=i.getFullYear(),s=i.getMonth()+1,l=i.getDate(),h=i.getDay();if(o)h=(h-1+7)%7;h=this.days[h];var u={yyyy:a,yy:a%100,y:a,mm:e(s),m:s,dd:e(l),d:l,w:h,ww:r.lang.week+h};return n.replace(/y+|M+|d+|W+/gi,function(e){return u[e]||""})},getYYYYMM:function(e){return"string"==typeof e?e:this.format(this.from(e),"yyyyMM")},render:function(){var e=this.options;if(!this.rendered){this.rendered=!0;var i=this.popup=new n(this.srcOptions);if(this.addChild(i),i.on("click",this.onClick),i.on("hide",this.onHide),i.on("beforeShow",this.onBeforeShow),this.main=i.main,t.addClass(this.main,"c-clearfix"),e.target)this.setTarget(t.g(e.target))}return this},build:function(e){var t=this.options,i=[];e=e||this.date;for(var n,r=e.getFullYear(),o=e.getMonth(),a=0,s=t.monthes;s>a;a++)n=new Date(r,o+a,1),i.push(this.buildMonth(n));var l=t.prefix;i.push('<a href="#" class="'+l+'-pre"></a>'),i.push('<a href="#" class="'+l+'-next"></a>');var h=this.popup;h.content=i.join(""),h.render(),this.updateStatus(),this.updatePrevNextStatus(e)},updatePrevNextStatus:function(e){var i=this.options,n=i.prefix,r=this.range,o=t.q(n+"-pre",this.main)[0],a=t.q(n+"-next",this.main)[0];if(e=e||this.date||this.from(this.value),o)t[!r||!r.begin||this.getYYYYMM(r.begin)<this.getYYYYMM(e)?"show":"hide"](o);var s=new Date(e.getFullYear(),e.getMonth()+i.monthes-1,1);if(a)t[!r||!r.end||this.getYYYYMM(r.end)>this.getYYYYMM(s)?"show":"hide"](a)},buildMonth:function(t){var i=t.getFullYear(),n=t.getMonth()+1,r=t.getDate(),a=t.getDay(),s=o[this.cacheKey],l=i+e(n);if(s[l])return s[l];var h=7,u=6,c="-",f=this.options,d=f.prefix,p=['<div class="'+d+'-month">'],g={year:i,month:n,prefix:d},m=f.lang.title.replace(/\{([^\}]+)\}/g,function(e,t){return g[t]||""});p.push("<h3>"+m+"</h3>");var y,v,_,b=f.first,x=this.days;for(p.push('<ul class="c-clearfix">'),y=0,v=x.length;v>y;y++)_=y===h-1||b&&y===h-2||!b&&y===b?' class="'+d+'-weekend"':"",p.push("<li"+_+">"+x[y]+"</li>");p.push("</ul>"),p.push('<p class="c-clearfix">');var w,S,T,C,E=0,A=(h+a+1-r%h)%h;if(v=A-b,v>0){for(t.setDate(0),w=t.getFullYear(),S=t.getMonth()+1,T=t.getDate(),C=[w,e(S),""].join(c),_=d+"-pre-month",y=T-v+1;T>=y;y++)E%=h,p.push('<a href="#" hidefocus class="'+_+'" data-date="'+C+e(y)+'" data-week="'+E+'">'+y+"</a>"),E++;t.setDate(T+1)}for(t.setDate(1),t.setMonth(n),t.setDate(0),C=[i,e(n),""].join(c),y=1,v=t.getDate();v>=y;y++)E%=h,p.push('<a href="#" hidefocus  data-date="'+C+e(y)+'" data-week="'+E+'">'+y+"</a>"),E++;for(t.setDate(v+1),w=t.getFullYear(),S=t.getMonth()+1,C=[w,e(S),""].join(c),_=d+"-next-month",v=h*u-(v+Math.max(0,A-b)),y=1;v>=y;y++)E%=h,p.push('<a href="#" hidefocus class="'+_+'" data-date="'+C+e(y)+'" data-week="'+E+'">'+y+"</a>"),E++;return p.push("</p>"),p.push("</div>"),s[l]=p.join(""),s[l]},onClick:function(e){var i=e.event;if(i){for(var n=t.getTarget(i),r=n.tagName,o=this.target;"A"!==r&&n!==this.main;)n=n.parentNode,r=n.tagName;switch(r){case"A":t.preventDefault(i);var a=this.options.prefix,s=a+"-pre",l=a+"-next",h=a+"-disabled",u=t.hasClass,c=t.stopPropagation;if(u(n,s))this.showPreMonth(),c(i);else if(u(n,l))this.showNextMonth(),c(i);else if(!u(n,h))n.getAttribute("data-date")&&this.pick(n);break;default:if(o)o.select()}this.fire("click",e)}},showPreMonth:function(){var e=this.date;e.setDate(0),this.build(e)},showNextMonth:function(){var e=this.date;e.setDate(1),e.setMonth(e.getMonth()+1),this.build(e)},updateStatus:function(){var e=this.options,t=e.prefix,i=e.process,n=e.first,o=new Date,a=this.target.value&&this.format(this.from(this.value),r),s=this.format(o,r),l=this.range,h="",u="9999-12-31";if(l)h=l.begin&&this.format(l.begin,r)||h,u=l.end&&this.format(l.end,r)||u;var c,f,d,p,g,m,y,v,_,b=t+"-pre-month",x=t+"-next-month",w=t+"-disabled",S=t+"-today",T=t+"-checked",C=t+"-weekend",E=this.main.getElementsByTagName("p");for(c=0,f=E.length;f>c;c++)for(g=E[c].getElementsByTagName("a"),d=0;p=g[d];d++){if(m=[],y=p.getAttribute("data-date"),v=p.className,_=!0,l&&(h>y||y>u))m.push(w),_=!1;var A=d%7;if(6===A||n&&5===A||!n&&0===A)m.push(C);if(~v.indexOf(b))m.push(b);else if(~v.indexOf(x))m.push(x);else{if(y===s)m.push(S);if(_&&y===a)m.push(T)}if(i)i.call(this,p,m,y,_);p.className=m.join(" ")}},onBeforeShow:function(e){this.fire("beforeShow",e);var t=this.popup,i=this.target,n=i.value;if(n)n=this.from(n),this.value=this.format(n);if(!t.content)this.date=this.from(n||this.value),this.build();var r=this.lastDate||"",o=this.lastTarget,a=this.getYYYYMM(this.date),s=this.getYYYYMM(n);if(r&&r!==this.format(n)||a!==s)if(this.date=this.from(n||this.value),r=r&&this.getYYYYMM(r),r!==s||a!==s)this.build();else this.updateStatus();else if(n!==r||i!==o)this.updateStatus()},setTarget:function(e){if(!e||1!==e.nodeType)throw new Error("target 为 null 或非 Element 节点");if(this.target=e,this.popup)this.popup.target=e},pick:function(e){var t=e.getAttribute("data-date"),i=e.getAttribute("data-week"),n=this.target,o=this.from(t,r);if(t=this.format(o),this.lastDate=t,n)if(n.type)n.value=t,n.focus();else n.innerHTML=t;this.fire("pick",{value:t,week:this.options.lang.week+this.days[i],date:o}),this.hide()},show:function(e){this.popup.show(),this.fire("show",{target:e})},onHide:function(){this.fire("hide")},hide:function(){this.popup.hide()},checkValidity:function(){return this.validate()},getValue:function(){var e=this.date,t=this.target;return this.format(e||t&&t.value||this.value)},getValueAsDate:function(){return this.from(this.getValue())},setRange:function(e){if(e){var i=e.begin,n=e.end;if(i&&t.isString(i))e.begin=this.from(i);if(n&&t.isString(n))e.end=this.from(n);this.range=e,this.updatePrevNextStatus()}},setValue:function(e){this.date=this.from(e),this.value=this.format(this.date),this.build()},validate:function(){var e=this.target.value;if(e){var t=this.from(e);if(this.format(t)===e){var i=this.range,n="",o="9999-12-31";if(i)return n=i.begin&&this.format(i.begin,r)||n,o=i.end&&this.format(i.end,r)||o,e=this.format(t,r),e>=n&&o>=e;else return!0}}return!1}});return a.DATE_FORMAT=r,a.RANGE=null,a});